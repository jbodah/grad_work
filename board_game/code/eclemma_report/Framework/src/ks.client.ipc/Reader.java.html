<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>Reader.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Merged (Apr 28, 2012 2:01:54 PM)</a> &gt; <a href="../../index.html" class="el_group">Framework</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.html" class="el_package">ks.client.ipc</a> &gt; <span class="el_source">Reader.java</span></div><h1>Reader.java</h1><pre class="source lang-java linenums">package ks.client.ipc;

import ks.framework.common.Message;
import ks.framework.common.network.CommunicationAgent;
import ks.framework.debug.Debug;

/**
 * The Reader class is responsible for interpreting all communication from the
 * server.
 * 
 * It executes in its own thread and communicates all messages back to 
 * a Processor.
 * 
 * @author George T. Heineman (heineman@cs.wpi.edu)
 */
class Reader implements Runnable {
	/** Input agent. */
	private CommunicationAgent agent;
	
	/** Client to whom we direct our actions. */
	Client client;
	
	/** Our own thread of control. */
<span class="nc" id="L24">	private Thread thread = null;</span>

	
	/** Construct reader with Talker in mind. */ 
<span class="nc" id="L28">	public Reader(CommunicationAgent agent, Client client) {</span>
<span class="nc" id="L29">		this.client = client;</span>
<span class="nc" id="L30">		this.agent = agent;</span>
<span class="nc" id="L31">	}</span>

	/**
	 * This thread waits for any input generated by Talker's behavior with the
	 * Server.
	 * 
	 * There may be problems when disconnecting since two threads are in
	 * contention for the serverOutput object stream (see readLine in Talker).
	 */
	public void run() {
		try {
			// The very first thing we read is going to be the initial LoginResponse
			// Block waiting for any response from the server.
<span class="nc" id="L44">			Debug.println (&quot;Client reader waiting to read LOGIN Response&quot;);</span>
<span class="nc" id="L45">			Message m = (Message) agent.readObject();</span>
			
			// deal with this loginResponse specially.
<span class="nc bnc" id="L48" title="All 2 branches missed.">			if (!m.getName().equals(&quot;loginResponse&quot;)) {</span>
<span class="nc" id="L49">				System.err.println(&quot;Received: &quot; + m + &quot; instead of loginResponse from server.&quot;);</span>
<span class="nc" id="L50">				return;</span>
			}
			
			// validate success
<span class="nc bnc" id="L54" title="All 2 branches missed.">			if (!m.success) {</span>
<span class="nc" id="L55">				System.err.println(&quot;Login Failure:&quot; + m.reason);</span>
<span class="nc" id="L56">				agent.close();</span>
<span class="nc" id="L57">				client.connected(false);</span>
<span class="nc" id="L58">				return;</span>
			}
			
			// have client know about this request.
<span class="nc" id="L62">			client.process (m);</span>
			
<span class="nc" id="L64">			while (true) {</span>
				// Block waiting for any response from the server.
<span class="nc" id="L66">				Debug.println (&quot;Client reader waiting to read&quot;);</span>
<span class="nc" id="L67">				m = (Message) agent.readObject();</span>
	
				// if null, the server has shut down.
<span class="nc bnc" id="L70" title="All 2 branches missed.">				if (m == null)</span>
<span class="nc" id="L71">					break;</span>
				
				// Have ClientInterface process the request. This is done to avoid reader
				// from having to know the entity who instantiated it.
<span class="nc" id="L75">				client.process (m);</span>
			}
<span class="nc" id="L77">		} catch (RuntimeException re) {</span>
<span class="nc" id="L78">			Debug.println (&quot;Exiting reader.&quot;);</span>
		}
		
		// terminate.
<span class="nc" id="L82">		agent.close();</span>
<span class="nc" id="L83">		client.connected(false);</span>
<span class="nc" id="L84">	}</span>

	/**
	 * Start the thread off as a Daemon thread.
	 */
	public void start() {
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (thread == null) {</span>
<span class="nc" id="L91">			Debug.println (&quot;Client reader starting&quot;);</span>
<span class="nc" id="L92">			thread = new Thread(this);</span>
<span class="nc" id="L93">			thread.setDaemon(true);</span>
<span class="nc" id="L94">			thread.start();</span>
		}
<span class="nc" id="L96">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span>Merged (Apr 28, 2012 2:01:54 PM)</div></body></html>